<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">

<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../neon-animation/animations/fade-in-animation.html">

<!--
Built on the Polymer Seed, for reusability, this element presents a modal calculator display. `fbv-calculator-modal` is as simple to include in your project as any other polymer element. Capabable of: addition, subtraction, multiplication and division. Returns a value to the parent, accesible through the 'value' property.

Example:

    <fbv-calculator-modal final-value="{{}}"></fbv-calculator-modal>

@group Seed Elements
@element fbv-calculator-modal
@demo demo/index.html
-->
<dom-module id="fbv-calculator-modal">
    

  <style>
      :host {
          display: block;
          box-sizing: border-box;
          --paper-fab-background: #35950b;
          --paper-tooltip-background: #333;
          --paper-dialog-title: {
              background-color: #35950b;
              font-size: 20px;
              color: white;
              padding-top:10px;
              padding-bottom:10px;
              margin-top:0;
              box-shadow: 0 1px 2px #555;
          }
      }
      
      #calculator{ 
          width: 450px;
          min-width: 420px;
          margin: 0;
      }
      
      .numbers{
          width: 72%;
          float: left;
      }
      
      #commands{
          width: 22%;
          float: right;
      }
      
     

  </style>

  <template>
    <!-- FAB toggles Modal  -->
    <paper-fab id="calculator-fab" icon="filter-list" on-tap="openCalculator"></paper-fab>
    <paper-tooltip id="calc-tooltip" for="calculator-fab">Abrir una calculadora en primer plano</paper-tooltip>
    <!--  Modal window: modal dialog. Presents the calculator's structure  -->
    <paper-dialog id="calculator" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
        <h2>Calculadora (Widget)</h2>
        <div id="panel">
            <div>
               <div class="numbers">
                   <div class="row">
                       <paper-input label="{{labelView(temporalValue, commandPresent)}}" value="{{newValue}}"></paper-input>
                   </div>
                    <div>
                        <paper-button id="number1" raised on-tap="numberPressed">1</paper-button>
                        <paper-button id="number2" raised on-tap="numberPressed">2</paper-button>
                        <paper-button id="number3" raised on-tap="numberPressed">3</paper-button>
                    </div>
                    <div>
                        <paper-button id="number4" raised on-tap="numberPressed">4</paper-button>
                        <paper-button id="number5" raised on-tap="numberPressed">5</paper-button>
                        <paper-button id="number6" raised on-tap="numberPressed">6</paper-button>
                    </div>
                    <div>
                        <paper-button id="number7" raised on-tap="numberPressed">7</paper-button>
                        <paper-button id="number8" raised on-tap="numberPressed">8</paper-button>
                        <paper-button id="number9" raised on-tap="numberPressed">9</paper-button>
                    </div>
                    <div>
                        <paper-button id="number0" raised on-tap="numberPressed"> 0 </paper-button>
                        <paper-button id="number10" raised on-tap="numberPressed"> . </paper-button>
                    </div>
                   </div>
               <div id="commands">
                   <br>
                    <paper-button id="commandplus" raised on-tap="commandPressed">+</paper-button>
                    <paper-button id="command-minus" raised on-tap="commandPressed">-</paper-button>
                    <paper-button id="command-times" raised on-tap="commandPressed">*</paper-button>
                    <paper-button id="command-divide" raised on-tap="commandPressed">/</paper-button>
                    <paper-button id="command-resultado" raised on-tap="commandResult">=</paper-button>
               </div>
            </div>
        </div>
        <div class="buttons">
            <paper-button on-tap="clearAll">C</paper-button>
            <paper-button on-tap="clearCurrent">CE</paper-button>
            <paper-icon-button raised icon="done" dialog-confirm on-tap="confirmValue"></paper-icon-button>
            <paper-icon-button icon="close" dialog-dismiss></paper-icon-button>
        </div>
    </paper-dialog>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'fbv-calculator-modal',

    properties: {
        /**
        * Temporal save of the input value. Concatenated String
        */
        newValue: {
            type: String,
            value: ''
        },
        
        /**
        * Bound property which returns to the parent element the final value calculated.
        */
        
        finalValue: {
            type: Number,
            value: 0,
            notify: true
        },
        
        /**
        * Temporal save of results throughout the calculations made.
        */
        temporalValue: {
            type: Number,
            value: 0
        },
        /**
        * Boolean variable used to track if a decimal point has been included in the input value.
        */
        dotPresent: {
            type: Boolean,
            value: false
        },
        
        /**
        * Temporal save of the command expected to be run con the inputs.
        */
        commandPresent: {
            type: String, 
            value: ''
        }
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior
    
    /**
    * This function is declared to assert that the element is well conected and ready to be tested and developed. 
    */
      
    hello: function(){
        return 'The calculator says hello!';
    },
      
    
    /**
    * Function that opens the dialog calculator
    */
    openCalculator: function(){
        this.$.calculator.open();
        return true;
    },
      
    labelView: function(a,b){
        return a + " " + b;
    },
     
      
    /**
    * Function saves the clicked number to the new value string.
    */
      
    numberPressed : function(event){
        if(this.newValue === '' && event.target.outerText !== '.' && this.temporalValue === 0){
            this.newValue = event.target.outerText;
        } else if (this.newValue === '' && event.target.outerText !== '.' && this.temporalValue !== 0 && this.commandPresent === ''){
            this.newValue = event.target.outerText;
            this.temporalValue = 0;
        } else if (event.target.outerText !== '.'){
            this.newValue += event.target.outerText;
        } else if (event.target.outerText === '.'){
            if(!this.dotPresent){
                this.newValue += event.target.outerText;
                this.dotPresent = true;
            }
        } 
        
    }, 
      
    /**
    * This function registers the pressing of a certain command and prepares the calculator for the next number to 
    * be introduced.
    */
    commandPressed: function(event){
        switch(event.target.outerText){
            case '+':
                if(this.newValue !== '' && this.temporalValue === 0){
                    this.commandPresent = event.target.outerText;
                    this.temporalValue = parseFloat(this.newValue);
                    this.newValue = '';
                    this.dotPresent = false;
                } else if (this.commandPresent !== '' && this.newValue !== ''){
                    var sumaTemp = this.evaluacionPrevia(this.newValue, this.temporalValue, this.commandPresent);
                    this.refreshPanel(sumaTemp, event.target.outerText);
                } else {
                    this.commandPresent = event.target.outerText;
                }
                break;
            case '-':
                if(this.newValue !== '' && this.temporalValue === 0){
                    this.commandPresent = event.target.outerText;
                    this.temporalValue = parseFloat(this.newValue);
                    this.newValue = '';
                    this.dotPresent = false;
                } else if (this.commandPresent !== '' && this.newValue !== ''){
                    var sumaTemp = this.evaluacionPrevia(this.newValue, this.temporalValue, this.commandPresent);
                    this.refreshPanel(sumaTemp, event.target.outerText);
                } else {
                    this.commandPresent = event.target.outerText;
                }
                break;
            case '*':
                if(this.newValue !== '' && this.temporalValue === 0){
                    this.commandPresent = event.target.outerText;
                    this.temporalValue = parseFloat(this.newValue);
                    this.newValue = '';
                    this.dotPresent = false;
                } else if (this.commandPresent !== '' && this.newValue !== ''){
                    var sumaTemp = this.evaluacionPrevia(this.newValue, this.temporalValue, this.commandPresent);
                    this.refreshPanel(sumaTemp, event.target.outerText);
                } else {
                    this.commandPresent = event.target.outerText;
                }
                break;
            case '/':
                if(this.newValue !== '' && this.temporalValue === 0){
                    this.commandPresent = event.target.outerText;
                    this.temporalValue = parseFloat(this.newValue);
                    this.newValue = '';
                    this.dotPresent = false;
                } else if (this.commandPresent !== '' && this.newValue !== ''){
                    var sumaTemp = this.evaluacionPrevia(this.newValue, this.temporalValue, this.commandPresent);
                    this.refreshPanel(sumaTemp, event.target.outerText);
                } else {
                    this.commandPresent = event.target.outerText;
                }
                break;
        }
    },
    /**
    * Evaluates a given operation with the values currently saved as new and temporal. This is: the latests input 
    * is evaluated with the expected command against the temporally saved value.
    *
    * nuevo @param Latest value input
    *
    * temporal @param Temporally saved value (intermediate result)
    *
    * commando @param Command expected to be run
    */
    evaluacionPrevia: function(nuevo, temporal, commando){
        switch(commando){
            case '+':
                var tempA = parseFloat(nuevo);
                return tempA + temporal;
                break;
            case '-':
                var tempA = parseFloat(nuevo);
                return temporal - tempA;
                break;
            case '*':
                var tempA = parseFloat(nuevo);
                return tempA*temporal;
                break;
            case '/':
                var tempA = parseFloat(nuevo);
                return temporal/tempA;
                break;
        }
    },
    /**
    * Refresh the panel between chained commands.
    */
    refreshPanel: function (sumaTemp, eventInfo) {
                    this.newValue = '';
                    this.temporalValue = sumaTemp;
                    this.commandPresent = eventInfo;
                    this.dotPresent = false;
    },
    /**
    * Calculate a final result.
    */ 
    commandResult: function(event) {
        if(this.newValue !== ''){
            var sumaTemp = this.evaluacionPrevia(this.newValue, this.temporalValue, this.commandPresent);
            this.newValue = '';
            this.temporalValue = sumaTemp;
            this.dotPresent = false;
            this.commandPresent = '';
        }
    },
    /**
    * Clear calculator
    */
    clearAll: function(){
        this.newValue = '';
        this.temporalValue = 0;
        this.commandPresent = '';
        this.dotPresent = false;
    },
    /**
    * Clear newValue and commandPresent
    */
    clearCurrent: function() {
        this.newValue = '';
        this.commandPresent = '';
    },
    /**
    * Final confirmation. Closes the dialog and passes the final result to the notified property `final-value`
    */  
    confirmValue: function(event) {
        this.commandResult(event);
        this.finalValue = this.temporalValue;
        this.newValue = '';
        this.dotPresent = false;
        this.commandPresent = '';
    }

  });

</script>
